<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>RenderTarget</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
<style>
    body {
	margin: 0;
	background-color: rgb(255, 255, 255);
	color: #fff;
	font-family: Monospace;
	overscroll-behavior: none;
}
#container{
    height: 100%;
    width: 100%;
    overscroll-behavior: none;
    position: absolute;
    overflow:hidden;
}
</style>
</head>
<body>
    <div id="container"></div>
    <!-- <script type="module" src="./cube.js"></script> -->
    <script type="module">
        import * as Spectre from "./build/js/spectre.js";
        let container;
        let renderer;
        let scene;
        let mesh;
        let camera;
        let directionalLight;
        let renderTarget;
        function init() {
            container = document.getElementById("container");
            renderer = new Spectre.WebGPURenderer({
                powerPreference: "high-performance",
                antialias: true,
            });
            container.appendChild(renderer.domElement);

            scene = new Spectre.Scene();

            camera = new Spectre.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 10000);
            camera.position.z = 200;
            camera.lookAt(new Spectre.Vector3(0, 0, 0));

            const controls = new Spectre.OrbitControls(camera, renderer.domElement);
            const geometry = new Spectre.PlaneGeometry(100,100);

            const material1 = new Spectre.MeshBasicMaterial();
            material1.color = new Spectre.Color(1, 0, 0);
            const mesh1 = new Spectre.Mesh(geometry, material1);
            scene.add(mesh1);

            const material2 = new Spectre.MeshBasicMaterial();
            material2.color = new Spectre.Color(0, 1, 0);
            const mesh2 = new Spectre.Mesh(geometry, material2);
            scene.add(mesh2);
            mesh2.translateX(100);
            mesh2.updateMatrix();

            const material3 = new Spectre.MeshBasicMaterial();

            renderTarget = new Spectre.RenderTarget(window.innerWidth,window.innerHeight);

            renderer.setRenderTarget(renderTarget);
            renderer.render(scene,camera);
            
            renderer.setRenderTarget(null);

            renderer.setRenderTarget(renderTarget);
            renderer.render(scene,camera);
            
            renderer.setRenderTarget(null);

            material3.map = renderTarget.texture;

            const mesh3 = new Spectre.Mesh(geometry, material3);
            scene.add(mesh3);
            mesh3.translateX(200);
            mesh3.updateMatrix();
        }

        let k = 0.01;
        function frame() {
            renderer.render(scene, camera);
            render();

            renderer.setRenderTarget(renderTarget);
            renderer.render(scene,camera);
            
            renderer.setRenderTarget(null);
        }

        function render() {
            requestAnimationFrame(() => {
                frame();
            });
        }

        function resize() {
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        window.addEventListener("resize", function () {
            resize();
        });

        Spectre.Init().then(()=>{
            init()
            render();
        });

    </script>
</body>
</html>